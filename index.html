<head>
	 <link rel="stylesheet" type="text/css" href="where_in_chicago.css">
	 <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script> <!-- adding google maps api -->
	<script> 
	
	var map; 	  //create map object
	var geocoder;
	var colorValues = [	
					"red", 
					"blue",
					"green", 
					"brown", 
					"purple", 
					"pink"
				]
	var curLat;  //store current lat and long
	var curLong;
	var infowindow = new google.maps.InfoWindow();

	function initialize() {
	 
	  var mapOptions = {
	    zoom: 12
	  };
	  
	  var currentNeighborhood ="Loop"; 
	  var curNeighborhood;  //variable for current neighborhood
	  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	  geocoder = new google.maps.Geocoder();  //initialize geocoder
	  
	  // Try HTML5 geolocation
	  if(navigator.geolocation) {
	    
		 
		 navigator.geolocation.getCurrentPosition(
			 function(position) {
	      	   var pos = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
			   curLat = position.coords.latitude;
			   curLong = position.coords.longitude;
			  var googLatLng = new google.maps.LatLng(curLat, curLong);
	 		  //start geocode
	 		  	geocoder.geocode({'latLng': googLatLng}, function(results, status) {
	 		    if (status == google.maps.GeocoderStatus.OK) {
	 		      if (results[1]) {
	 		        map.setZoom(11);
	 		       /* marker = new google.maps.Marker({
	 		            position: googLatLng,
	 		            map: map
	 		        });*/
					
	 				var curNeighborhood = results[4].formatted_address;  //find the name of the current neighborhood (results[4] is the neighborhood level)
	 				curNeighborhood = curNeighborhood.substring(0, curNeighborhood.indexOf(','));  //delete everything after the neighborhood
	 		        
		  		    map.data.loadGeoJson('http://127.0.0.1:8000/neighborhoods.json')
		  			map.data.setStyle(function(feature) {
		  				var varHood = feature.getProperty("PRI_NEIGH");
		  				if(varHood=="Loop"){
		  					alert(curNeighborhood);
		  				}
		  				var color = varHood == curNeighborhood ? 'red':'blue';
		  			    return {
		  			      fillColor: color,
		  			      strokeWeight: .5
		  			    };
		  			});
					
					infowindow.setContent(curNeighborhood);
	 		        infowindow.open(map, marker);
					
					
	 		      } else {
	 		        alert('No results found');
	 		      }
	 		    } else {
	 		      alert('Geocoder failed due to: ' + status);
	 		    }
	 		  });
	 		  //stop geocode
			  
    		map.setCenter(pos);	
  		   
			
			   var infowindow = new google.maps.InfoWindow({
	        	   map: map,
	      		   position: pos,
	      	       content: curNeighborhood   
				   
	      });
			
		  	
			
	    }, function() {
	      handleNoGeolocation(true); //runs if there is an error in finding the location
	    });
	  } else {
	    // Browser doesn't support Geolocation
	    handleNoGeolocation(false);
	  }
	}

	function handleNoGeolocation(errorFlag) {
	  if (errorFlag) {
	    var content = 'Error: The Geolocation service failed.';
	  } else {
	    var content = 'Error: Your browser doesn\'t support geolocation.';
	  }

	  var options = {
	    map: map,
	    position: new google.maps.LatLng(41.878020, -87.630071), //default map
	    content: content //infowindow gives an errorcode
	  };

	  var infowindow = new google.maps.InfoWindow(options);
	  map.setCenter(options.position);
	}


	function codeLatLng() {
  	  var latlongBox = document.getElementById("latlngInput");
  	  latlongBox.value = curLat+", "+curLong;  //pass current Lat and Long to html
	  var input = document.getElementById('latlngInput').value;
	  var latlngStr = input.split(',', 2);
	  var lat = parseFloat(latlngStr[0]);
	  var lng = parseFloat(latlngStr[1]);
	  
	  var latlng = new google.maps.LatLng(lat, lng);
	  
	  geocoder.geocode({'latLng': latlng}, function(results, status) {
	    if (status == google.maps.GeocoderStatus.OK) {
	      if (results[1]) {
	        map.setZoom(11);
	        marker = new google.maps.Marker({
	            position: latlng,
	            map: map
	        });
			var neighborhood = results[4].formatted_address;  //find the name of the current neighborhood (results[4] is the neighborhood level)
			neighborhood = neighborhood.substring(0, neighborhood.indexOf(','));  //delete everything after the neighborhood
	        infowindow.setContent(neighborhood);
	        infowindow.open(map, marker);
	      } else {
	        alert('No results found');
	      }
	    } else {
	      alert('Geocoder failed due to: ' + status);
	    }
	  });
	}
	

	google.maps.event.addDomListener(window, 'load', initialize);
	</script>
</head>

<body>
<div id = "title">Chicago Neighborhood Finder</div>
 <div id="map-canvas"></div>
 <div id="panel">
      <input id="latlngInput" type="text" value="41.8940, -87.8197">
      <input type="button" value="Reverse Geocode" onclick="codeLatLng()">
    </div>

</body>